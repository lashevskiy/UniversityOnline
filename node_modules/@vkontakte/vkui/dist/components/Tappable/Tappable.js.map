{"version":3,"sources":["../../../src/components/Tappable/Tappable.js"],"names":["ts","Date","now","baseClassNames","ACTIVE_DELAY","ACTIVE_EFFECT_DELAY","storage","deactivateOtherInstances","exclude","Object","keys","filter","id","forEach","clearTimeout","activeTimeout","timeout","stop","Tappable","props","originalEvent","stopPropagation","touches","length","IS_PLATFORM_ANDROID","onDown","getStorage","setTimeout","start","shiftXAbs","shiftYAbs","isSlide","state","active","activeEffectDelay","store","e","container","top","left","x","y","key","toString","setState","clicks","Math","round","wavesTimeout","getRootRef","random","children","className","component","restProps","Component","disabled","Touch","classes","onStart","onMove","onEnd","ref","getRef","map","k","onClick","PropTypes","func","string","node","oneOfType","element","role","number","bool"],"mappings":"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","sourcesContent":["\nimport React, { Component } from 'react';\nimport PropTypes from 'prop-types';\nimport Touch from '../Touch/Touch';\nimport classNames from '../../lib/classNames';\nimport getClassName from '../../helpers/getClassName';\nimport { IS_PLATFORM_ANDROID } from '../../lib/platform';\nimport { getOffsetRect } from '../../lib/offset';\nimport { coordX, coordY } from '../../lib/touch';\n\nconst ts = () => +Date.now();\nconst baseClassNames = getClassName('Tappable');\n\nconst ACTIVE_DELAY = 70;\nexport const ACTIVE_EFFECT_DELAY = 600;\n\nlet storage = {};\n\n/**\n * Очищает таймауты и хранилище для всех экземпляров компонента, кроме переданного\n *\n * @param {String} exclude ID экземпляра-исключения\n * @returns {void}\n */\nfunction deactivateOtherInstances (exclude) {\n  Object.keys(storage).filter(id => id !== exclude).forEach(id => {\n    clearTimeout(storage[id].activeTimeout);\n    clearTimeout(storage[id].timeout);\n    storage[id].stop();\n\n    delete storage[id];\n  });\n}\n\nexport default class Tappable extends Component {\n  constructor (props) {\n    super(props);\n    this.id = Math.round(Math.random() * 1e8).toString(16);\n    this.state = {\n      clicks: {},\n      active: false,\n      ts: null\n    };\n  }\n\n  static propTypes = {\n    onClick: PropTypes.func,\n    className: PropTypes.string,\n    children: PropTypes.node,\n    component: PropTypes.oneOfType([\n      PropTypes.string,\n      PropTypes.element\n    ]),\n    role: PropTypes.string,\n    activeEffectDelay: PropTypes.number,\n    stopPropagation: PropTypes.bool,\n    disabled: PropTypes.bool,\n    getRootRef: PropTypes.func\n  };\n\n  static defaultProps = {\n    component: 'div',\n    role: 'button',\n    stopPropagation: false,\n    disabled: false,\n    activeEffectDelay: ACTIVE_EFFECT_DELAY\n  };\n\n  isSlide = false;\n\n  /**\n   * Обрабатывает событие touchstart\n   *\n   * @returns {void}\n   */\n  onStart = ({ originalEvent }) => {\n    this.props.stopPropagation && originalEvent.stopPropagation();\n    if (originalEvent.touches && originalEvent.touches.length > 1) {\n      return deactivateOtherInstances();\n    }\n\n    if (IS_PLATFORM_ANDROID) {\n      this.onDown(originalEvent);\n    }\n\n    storage[this.id] = {};\n    this.getStorage().stop = this.stop;\n    this.getStorage().activeTimeout = setTimeout(this.start, ACTIVE_DELAY);\n  };\n\n  /**\n   * Обрабатывает событие touchmove\n   *\n   * @returns {void}\n   */\n  onMove = ({ originalEvent, shiftXAbs, shiftYAbs }) => {\n    this.props.stopPropagation && originalEvent.stopPropagation();\n    if (shiftXAbs > 20 || shiftYAbs > 20) {\n      this.isSlide = true;\n      this.stop();\n    }\n  };\n\n  /**\n   * Обрабатывает событие touchend\n   *\n   * @returns {void}\n   */\n  onEnd = ({ originalEvent }) => {\n    this.props.stopPropagation && originalEvent.stopPropagation();\n    const now = ts();\n\n    if (originalEvent.touches && originalEvent.touches.length > 0) {\n      this.isSlide = false;\n      return;\n    }\n\n    if (this.state.active) {\n      if (now - this.state.ts >= 100) {\n        // Долгий тап, выключаем подсветку\n        this.stop();\n      } else {\n        // Короткий тап, оставляем подсветку\n        const timeout = setTimeout(this.stop, this.props.activeEffectDelay - now + this.state.ts);\n        const store = this.getStorage();\n\n        if (store) {\n          store.timeout = timeout;\n        }\n      }\n    } else if (!this.isSlide) {\n      // Очень короткий тап, включаем подсветку\n      this.start();\n\n      const timeout = setTimeout(this.stop, this.props.activeEffectDelay);\n\n      if (this.getStorage()) {\n        clearTimeout(this.getStorage().activeTimeout);\n        this.getStorage().timeout = timeout;\n      } else {\n        this.timeout = timeout;\n      }\n    }\n\n    this.isSlide = false;\n  };\n\n  /**\n   * Реализует эффект при тапе для Андроида\n   *\n   * @returns {void}\n   */\n  onDown = (e) => {\n    if (IS_PLATFORM_ANDROID) {\n      const { top, left } = getOffsetRect(this.container);\n      const x = coordX(e);\n      const y = coordY(e);\n      const key = 'wave' + Date.now().toString();\n\n      this.setState(state => ({\n        clicks: {\n          ...state.clicks,\n          [key]: {\n            x: Math.round(x - left),\n            y: Math.round(y - top)\n          }\n        }\n      }));\n\n      this.wavesTimeout = setTimeout(() => {\n        this.setState(state => {\n          let clicks = { ...state.clicks };\n          delete clicks[key];\n          return { clicks };\n        });\n      }, 225);\n    }\n  };\n\n  /**\n   * Устанавливает активное выделение\n   *\n   * @returns {void}\n   */\n  start = () => {\n    if (!this.state.active) {\n      this.setState({\n        active: true,\n        ts: ts()\n      });\n    }\n    deactivateOtherInstances(this.id);\n  };\n\n  /**\n   * Снимает активное выделение\n   *\n   * @returns {void}\n   */\n  stop = () => {\n    if (this.state.active) {\n      this.setState({\n        active: false,\n        ts: null\n      });\n    }\n    if (this.getStorage()) {\n      clearTimeout(this.getStorage().activeTimeout);\n      delete storage[this.id];\n    }\n  };\n\n  /**\n   * Возвращает хранилище для экземпляра компонента\n   *\n   * @returns {Object} Хранилище для текущего экземпляра компонента\n   */\n  getStorage = () => {\n    return storage[this.id];\n  };\n\n  /**\n   * Берет ref на DOM-ноду из экземпляра Touch\n   *\n   * @param {React.Component} container Touch component instance\n   */\n  getRef = container => {\n    this.container = container;\n    this.props.getRootRef && this.props.getRootRef(container);\n  };\n\n  componentWillUnmount () {\n    if (storage[this.id]) {\n      clearTimeout(storage[this.id].timeout);\n      clearTimeout(storage[this.id].activeTimeout);\n\n      delete storage[this.id];\n    }\n\n    clearTimeout(this.wavesTimeout);\n  }\n\n  render () {\n    const { clicks, active } = this.state;\n    const { children, className, component, activeEffectDelay, stopPropagation, getRootRef, ...restProps } = this.props;\n    const Component = !restProps.disabled ? Touch : component;\n    const classes = classNames(baseClassNames, className, {\n      'Tappable--active': active,\n      'Tappable--inactive': !active\n    });\n\n    let props = {};\n\n    if (!restProps.disabled) {\n      props.component = component;\n      props.onStart = this.onStart;\n      props.onMove = this.onMove;\n      props.onEnd = this.onEnd;\n    }\n\n    if (typeof Component === 'string') {\n      props.ref = this.getRef;\n    } else {\n      props.getRootRef = this.getRef;\n    }\n\n    return (\n      <Component {...restProps} className={classes} {...props}>\n        {IS_PLATFORM_ANDROID && (\n          <span className=\"Tappable__waves\">\n            {Object.keys(clicks).map(k => (\n              <span className=\"Tappable__wave\" style={{ top: clicks[k].y, left: clicks[k].x }} key={k} />\n            ))}\n          </span>\n        )}\n        {children}\n      </Component>\n    );\n  }\n}\n"],"file":"Tappable.js"}